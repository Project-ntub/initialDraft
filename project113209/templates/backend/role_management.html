{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>角色管理</title>
    <link
      rel="stylesheet"
      href="{% static 'backend/css/role_management.css' %}"
    />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <button
            class="btn {% if current_page == 'role_management' %}active{% endif %}"
            onclick="location.href='{% url 'backend:role_management' %}'"
          >
            角色
          </button>
          <button
            class="btn {% if current_page == 'module_management' %}active{% endif %}"
            onclick="location.href='{% url 'backend:module_management' %}'"
          >
            模組
          </button>
        </div>
      </div>
      <h2>角色管理</h2>
      <button id="add-role-btn" class="btn" onclick="openCreateRoleModal()">
        新增角色
      </button>
      <label for="chart-module-select">圖表模組:</label>
      <select id="chart-module-select" onchange="filterRolesByModule()">
        <option value="all">所有模組</option>
        {% for module in modules %}
        <option value="{{ module.name }}">{{ module.name }}</option>
        {% endfor %}
      </select>
      <table class="role-table">
        <thead>
          <tr>
            <th>角色名稱</th>
            <th>角色狀態</th>
            <th>用戶數</th>
            <th>角色成員</th>
            <th>模組</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="role-tbody">
          {% for role in roles %}
          <tr class="role-row" data-module="{{ role.module }}">
            <td>{{ role.name }}</td>
            <td>
              {% if role.is_active %}
              <button
                class="status-btn"
                onclick="toggleStatus({{ role.id }}, false)"
              >
                關閉
              </button>
              {% else %}
              <button
                class="status-btn"
                onclick="toggleStatus({{ role.id }}, true)"
              >
                開啟
              </button>
              {% endif %}
            </td>
            <td>{{ role.users.count }}</td>
            <td>
              <select>
                {% for user in role.users.all %}
                <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
              </select>
            </td>
            <td>{{ role.module }}</td>
            <td>
              <button
                class="permissions-btn"
                onclick="location.href='{% url 'backend:edit_role' role.id %}'"
              >
                角色權限
              </button>
              <button
                class="delete-btn"
                onclick="location.href='{% url 'backend:delete_role' role.id %}'"
              >
                刪除
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="create-role-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeCreateRoleModal()">&times;</span>
        <h2>新增角色</h2>
        <form method="post" action="{% url 'backend:create_role' %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="role-name">角色名稱</label>
            <input type="text" id="role-name" name="name" required />
          </div>
          <div class="form-group">
            <label for="role-module">模組</label>
            <select id="role-module" name="module" required>
              {% for module in modules %}
              <option value="{{ module.id }}">{{ module.name }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn">新增</button>
        </form>
      </div>
    </div>

    <script>
      function filterRolesByModule() {
        const selectedModule = document.getElementById(
          "chart-module-select"
        ).value;
        const rows = document.querySelectorAll(".role-row");
        rows.forEach((row) => {
          if (
            selectedModule === "all" ||
            row.dataset.module === selectedModule
          ) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      function toggleStatus(roleId, isActive) {
        fetch(`/backend/toggle_role_status/${roleId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({ is_active: isActive }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              location.reload();
            } else {
              alert("狀態更新失敗");
            }
          });
      }

      function openCreateRoleModal() {
        document.getElementById("create-role-modal").style.display = "block";
      }

      function closeCreateRoleModal() {
        document.getElementById("create-role-modal").style.display = "none";
      }
    </script>
  </body>
</html>
